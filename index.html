<!-- Simulates what an IDP page would need to do to handle external window conversations -->
<!DOCTYPE html>
<html>

<head>

    <script>
        // Example function that gets value of a specified querystring parameter
        function getURLParam(name) {
            var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
            if (results == null) {
                return null;
            } else {
                return results[1] || 0;
            }
        }

        // Simulates the service called to return a JWT
        function getJWT() {
            return "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3MzgwNTI1ODMsImlhdCI6MTY1MTY1MjU4MywiaXNzIjoiaHR0cHM6Ly9scC1leGFtcGxlLWFjY291bnQuY29tIiwibHBfc2RlcyI6W3siaW5mbyI6eyJhY2NvdW50TmFtZSI6ImJhbmsgY29ycCIsImJhbGFuY2UiOi00MDAuOTksImNvbXBhbnlCcmFuY2giOiJCcm9hZGJhbmQiLCJjb21wYW55U2l6ZSI6NTAwLCJjc3RhdHVzIjoiY2FuY2VsbGVkIiwiY3R5cGUiOiJ2aXAiLCJjdXJyZW5jeSI6IlVTRCIsImN1c3RvbWVySWQiOiIxMzg3NjZBQyIsImltZWkiOiIxMjM0NTY3ODkwMTIzNDUiLCJsYXN0UGF5bWVudERhdGUiOnsiZGF5IjoxNSwibW9udGgiOjEwLCJ5ZWFyIjoyMDE0fSwicmVnaXN0cmF0aW9uRGF0ZSI6eyJkYXkiOjIzLCJtb250aCI6NSwieWVhciI6MjAxM30sInJvbGUiOiJicm9rZXIiLCJzb2NpYWxJZCI6IjExMjU2MzI0NzgwIiwic3RvcmVOdW1iZXIiOiIxMjM4NjUiLCJzdG9yZVppcENvZGUiOiIyMDUwNSIsInVzZXJOYW1lIjoidXNlcjAwMCJ9LCJ0eXBlIjoiY3RtcmluZm8ifSx7InBlcnNvbmFsIjp7ImFnZSI6eyJhZ2UiOjM0LCJkYXkiOjE1LCJtb250aCI6NCwieWVhciI6MTk4MH0sImNvbXBhbnkiOiJjb21wYW55IiwiY29udGFjdHMiOlt7ImVtYWlsIjoibXluYW1lMUBleGFtcGxlLmNvbSIsInBob25lIjoiMDcwMDAwMDAwMDAifV0sImdlbmRlciI6Ik1BTEUiLCJsYW5ndWFnZSI6ImVuLVVTIn0sInR5cGUiOiJwZXJzb25hbCJ9XSwic3ViIjoiYmVzdFByYWN0aWNlMSJ9.phsOL4_zH5SoX7TJ647T1kX0SjdSYOomm6coKkQGIOZf4318QGBC0_90B8_OQh8PW1FhXpGifyUt28SZ-F0fCIwZQVG3yuC_ufVs5pFgJk7w1oIDU2ZQv2Q2YQCtxGAteKnQR_R4j-GcZPW1TeGlQDtPcqLAc1E62mLWWfGPV0gwhApq_-o2aa07JEkqx_YIF3_sD-Lbkn2A8y4MigUMmUIWBH4sR43x1W6injgNbrhQkQzUErR_zWWSIAcu0VCvh5azre6fTllqxEqb__iJHyW0Jx3kD-5qgu12va0lq698JMzqRVdlxIwQv3jKQByyaqVFKxHXdyhQqv_Plfj9uA";
        }

        function authenticate() {

            // We pass you the URL of our conversation window as a querystring value called 'redirect_uri' - read this value
            var chatURL = getURLParam("redirect_uri");
            var state = getURLParam("state");
            console.log("chatURI="+chatURL+"STATE="+state)
            //debugger;
            if (chatURL) {
                chatURL = unescape(chatURL);

                // Call your service to get JWT
                var JWT = getJWT();

                if (JWT === "") {
                    // No valid JWT supplied - show message telling customer they are unauthenticated
                    document.getElementById("notAuth").style.display = "block";
                }
                else {
                    // Valid JWT supplied - redirect window to conversation window URL
                    // Add the JWT on the end of the URL in the "code" querystring parameter
                    // e.g. "https://www.chatwindow.com/chat.html?code=[JWT]"
                    if (state) {
                        chatURL += "?state=" + state + "&code=" + JWT;
                    } else {
                        chatURL += "&code=" + JWT;
                    }
                    
                    chatURL = decodeURIComponent(chatURL);
                    window.location.href = chatURL;
                }
            }
        }
    </script>

</head>

<body>
    <div id="notAuth" style="display:none">
        Sorry, you are no longer authenticated. Please log back into eBanking.
    </div>
    <script>
        authenticate();
    </script>
</body>

</html>